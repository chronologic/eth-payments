#!/usr/bin/env node
const commander = require('commander');

const config = require("../config");
const pkgJson = require('../package.json');

const PaymentService = require('../lib/PaymentService');

const listDecomposer = (val) => {
  return val.split(',');
};

commander
  .version(pkgJson.version);

commander
  .option('-s, --source', 'Source ETH address')
  .option('-S, --sources', 'Comma-separated list of source addresses', listDecomposer);

commander
  .option('-t, --target', 'Target ETH address')
  .option('-T, --targets', 'Comma-separated list of target addresses', listDecomposer);

commander
  .option('-e, --eth', 'ETH Amount');

commander
  .command('collect')
  .description('collect ETH from multiple accounts')
  .action(function () {
    let ps = new PaymentService();
    return ps
      .flow(commander.eth, commander.sources || [commander.source] || [], [commander.target])
      .then(() => {
        console.log('ETH have been collected.');
        process.exit();
      })
      .catch((err) => {
        console.log(`Some shit happened: ${err.message}`);
        process.exit();
      });
  });

commander
  .command('distribute')
  .description('distribute ETH to multiple accounts')
  .action(function () {
    let ps = new PaymentService();
    return ps
      .flow(commander.eth, [commander.source], commander.targets || [commander.target] || [])
      .then(() => {
        console.log('ETH have been distributed.');
        process.exit();
      })
      .catch((err) => {
        console.log(`Some shit happened: ${err.message}`);
        process.exit();
      });
  });

commander.on('--help', function () {
  console.log('  Example:');
  console.log();
  console.log('    $ payments collect');
  console.log('    $ payments distribute');
  console.log();
});

commander.parse(process.argv);